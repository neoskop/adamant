!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("reflect-metadata"),require("@angular/core"),require("fast-deep-equal")):"function"==typeof define&&define.amd?define("@neoskop/adamant",["exports","reflect-metadata","@angular/core","fast-deep-equal"],e):e((t.neoskop=t.neoskop||{},t.neoskop.adamant={}),null,t.ng.core,t.fastDeepEqual)}(this,function(t,e,i,n){"use strict";var r=function(t,e){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)};function o(t,e){function n(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}var a=function(){return(a=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var i in e=arguments[n])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t}).apply(this,arguments)};function M(t,e){var n={};for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&e.indexOf(r)<0&&(n[r]=t[r]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(r=Object.getOwnPropertySymbols(t);i<r.length;i++)e.indexOf(r[i])<0&&(n[r[i]]=t[r[i]])}return n}function l(e,a,s,u){return new(s||(s=Promise))(function(t,n){function r(t){try{o(u.next(t))}catch(e){n(e)}}function i(t){try{o(u["throw"](t))}catch(e){n(e)}}function o(e){e.done?t(e.value):new s(function(t){t(e.value)}).then(r,i)}o((u=u.apply(e,a||[])).next())})}function D(r,i){var o,a,s,t,u={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return t={next:e(0),"throw":e(1),"return":e(2)},"function"==typeof Symbol&&(t[Symbol.iterator]=function(){return this}),t;function e(e){return function(t){return function n(t){if(o)throw new TypeError("Generator is already executing.");for(;u;)try{if(o=1,a&&(s=2&t[0]?a["return"]:t[0]?a["throw"]||((s=a["return"])&&s.call(a),0):a.next)&&!(s=s.call(a,t[1])).done)return s;switch(a=0,s&&(t=[2&t[0],s.value]),t[0]){case 0:case 1:s=t;break;case 4:return u.label++,{value:t[1],done:!1};case 5:u.label++,a=t[1],t=[0];continue;case 7:t=u.ops.pop(),u.trys.pop();continue;default:if(!(s=0<(s=u.trys).length&&s[s.length-1])&&(6===t[0]||2===t[0])){u=0;continue}if(3===t[0]&&(!s||t[1]>s[0]&&t[1]<s[3])){u.label=t[1];break}if(6===t[0]&&u.label<s[1]){u.label=s[1],s=t;break}if(s&&u.label<s[2]){u.label=s[2],u.ops.push(t);break}s[2]&&u.ops.pop(),u.trys.pop();continue}t=i.call(r,u)}catch(e){t=[6,e],a=0}finally{o=s=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([e,t])}}}function E(t){var e="function"==typeof Symbol&&t[Symbol.iterator],n=0;return e?e.call(t):{next:function(){return t&&n>=t.length&&(t=void 0),{value:t&&t[n++],done:!t}}}}function A(t,e){var n="function"==typeof Symbol&&t[Symbol.iterator];if(!n)return t;var r,i,o=n.call(t),a=[];try{for(;(void 0===e||0<e--)&&!(r=o.next()).done;)a.push(r.value)}catch(s){i={error:s}}finally{try{r&&!r.done&&(n=o["return"])&&n.call(o)}finally{if(i)throw i.error}}return a}var s=new WeakMap,f=new WeakMap;function j(t,e){return s.has(t)?s.get(t).filter(function(t){return!e||t instanceof e}):[]}function u(t,e){s.has(t)||s.set(t,[]),s.get(t).push(e)}function O(t){return f.has(t)?f.get(t):new Map}function c(t,e,n){f.has(t)||f.set(t,new Map),f.get(t).has(e)||f.get(t).set(e,[]),f.get(t).get(e).push(n)}function d(t,e){var n,r;try{for(var i=E(Object.keys(e)),o=i.next();!o.done;o=i.next()){var a=o.value;t[a]=e[a]}}catch(s){n={error:s}}finally{try{o&&!o.done&&(r=i["return"])&&r.call(i)}finally{if(n)throw n.error}}return t}var N=function(){function t(){}return t.prototype.validate=function(t,e){if(this.required&&null==t)throw new Error('Property "'+("symbol"==typeof e?Symbol.keyFor(e):e)+'" required')},t}();var q=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return o(e,t),Object.defineProperty(e.prototype,"type",{get:function(){return i.resolveForwardRef(this._type)},set:function(t){this._type=t},enumerable:!0,configurable:!0}),e}(N),P=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return o(e,t),e}(q);var I=function nt(){};var g=function rt(){};var T=function it(){};var S=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return o(e,t),e}(q);var R=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return o(e,t),e}(q);var h={Static:"static"},C=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.required=!0,t}return o(t,e),t}(N);var F=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return o(e,t),e}(q);var x=function ot(){};var k=function at(){};var V=function st(){};var p=function ut(){},y=function ct(){},v=new i.InjectionToken("ADAMANT_CONNECTION"),w=new i.InjectionToken("ADAMANT_ENTITY_CLASS"),m=new i.InjectionToken("ADAMANT_ENTITY_METADATA"),b=new i.InjectionToken("ADAMANT_EQUAL_CHECKER"),_=new i.InjectionToken("ADAMANT_CONNECTION_FACTORY"),B=new i.InjectionToken("ADAMANT_ID");function H(t){return Object.defineProperty(t,"_deleted",{configurable:!0,value:!0}),t}function U(t,e){return Object.defineProperty(t,"_id",{configurable:!0,value:e.id}),Object.defineProperty(t,"_rev",{configurable:!0,value:e.rev}),t}var Y=function(){function t(t){this.entity=t,this.inline=!1,this.properties=new Map,this.parse(),this.assert()}return t.prototype.parse=function(){var t,e,n,r,i,o,a=j(this.entity),s=O(this.entity);try{for(var u=E(a),c=u.next();!c.done;c=u.next()){((w=c.value)instanceof g||w instanceof x)&&Object.assign(this,w)}}catch(m){t={error:m}}finally{try{c&&!c.done&&(e=u["return"])&&e.call(u)}finally{if(t)throw t.error}}try{for(var d=E(s),l=d.next();!l.done;l=d.next()){var f=A(l.value,2),h=f[0],p=f[1];try{for(var y=E(p),v=y.next();!v.done;v=y.next()){var w;(w=v.value)instanceof C&&(this.id=h,this.idType=w.type,this.idStrategy=w.strategy),w instanceof N&&this.properties.set(h,w)}}catch(b){i={error:b}}finally{try{v&&!v.done&&(o=y["return"])&&o.call(y)}finally{if(i)throw i.error}}}}catch(_){n={error:_}}finally{try{l&&!l.done&&(r=d["return"])&&r.call(d)}finally{if(n)throw n.error}}},t.prototype.assert=function(){var t,e;try{for(var n=E(this.inline?[]:["id","idStrategy","name","attachments"]),r=n.next();!r.done;r=n.next()){var i=r.value;if(null==this[i])throw new Error("Missing metadata '"+i+"' for entity \""+this.entity.name+'"')}}catch(o){t={error:o}}finally{try{r&&!r.done&&(e=n["return"])&&e.call(n)}finally{if(t)throw t.error}}},t}(),Q={Create:"create",Update:"update",Delete:"delete"},L=function(){function t(t,e,n,r,i){this.db=t,this.entityClass=e,this.metadata=n,this.hydrator=r,this.validator=i}return t.prototype.bulk=function(o,a){return l(this,void 0,void 0,function(){var e,n,r,i=this;return D(this,function(t){switch(t.label){case 0:return 0===o.length?[2,o]:[4,Promise.all(o.map(function(n){return l(i,void 0,void 0,function(){var e;return D(this,function(t){switch(t.label){case 0:if(!(n instanceof this.entityClass))throw new Error('Entity "'+n+'" is not instanceof '+this.entityClass.name);return[4,this.validator.validate(n,this.metadata)];case 1:return t.sent(),e=this.hydrator.dehydrate(n,this.metadata,{includeRev:a===Q.Update||a===Q.Delete}),a===Q.Delete&&(e._deleted=!0),[2,e]}})})}))];case 1:return e=t.sent(),[4,this.db.bulkDocs(e)];case 2:if(n=t.sent(),0<(r=n.filter(function(t){return Object.prototype.hasOwnProperty.call(t,"error")})).length)throw r;return n.forEach(function(t,e){a===Q.Delete&&H(o[e]),U(o[e],t)}),[2,o]}})})},t.prototype.create=function(t){return this.bulk(t,Q.Create)},t.prototype.update=function(t){return this.bulk(t,Q.Update)},t.prototype["delete"]=function(t){return this.bulk(t,Q.Delete)},t.ctorParameters=function(){return[{type:undefined,decorators:[{type:i.Inject,args:[v]}]},{type:undefined,decorators:[{type:i.Inject,args:[w]}]},{type:Y,decorators:[{type:i.Inject,args:[m]}]},{type:p},{type:y}]},t}();var $=function(){function t(t){this.db=t,this.queue=[]}return t.prototype.read=function(e){var t;return(t=this.queue).push.apply(t,function n(){for(var t=[],e=0;e<arguments.length;e++)t=t.concat(A(arguments[e]));return t}(e)),this.schedule().then(function(t){return e.map(function(e){return t.find(function(t){return t._id===e})}).filter(Boolean).map(function(t){return JSON.parse(JSON.stringify(t))})})},t.prototype.schedule=function(){var t=this;return this.deffered||(setImmediate(function(){t.execute()}),this.deffered=function e(){var n,r,t=new Promise(function(t,e){n=t,r=e});return Object.assign(t,{resolve:n,reject:r})}(),this.deffered.then(function(){delete t.deffered},function(){delete t.deffered})),this.deffered},t.prototype.execute=function(){return l(this,void 0,void 0,function(){var e,n,r;return D(this,function(t){switch(t.label){case 0:e=this.queue.filter(function(t,e,n){return e===n.indexOf(t)}),this.queue=[],t.label=1;case 1:return t.trys.push([1,3,,4]),[4,this.db.allDocs({include_docs:!0,keys:e})];case 2:return n=t.sent().rows,this.deffered.resolve(n.map(function(t){return t.doc}).filter(Boolean)),[3,4];case 3:return r=t.sent(),this.deffered.reject(r),[3,4];case 4:return[2]}})})},t}(),J=function(){function t(t,e,n){this.repository=t,this._selector={},this._sort=[],this._selector._id={$gt:e,$lt:n}}return t.prototype.selector=function(t,e){if("string"==typeof t)"object"!=typeof e&&(e={$eq:e}),t in this._selector?Object.assign(this._selector[t],e):this._selector[t]=e;else for(var n in t)this.selector(n,t[n]);return this},t.prototype.sort=function(t,e){var n;return"string"==typeof t&&e?this._sort.push(((n={})[t]=e,n)):this._sort.push(t),this},t.prototype.limit=function(t){return this._limit=t,this},t.prototype.skip=function(t){return this._skip=t,this},t.prototype.resolve=function(t){return this.repository.executeQuery(this,t)},t.prototype.toFindRequest=function(){var t={selector:this._selector};return 0<this._sort.length&&(t.sort=this._sort),null!=this._limit&&(t.limit=this._limit),null!=this._skip&&(t.skip=this._skip),t},t}();function K(){return n}var W=function(){function t(t,e,n,r,i,o,a,s){this.db=t,this.entityClass=e,this.metadata=n,this.equal=r,this.id=i,this.bulk=o,this.hydrator=a,this.validator=s,this.queryBatcher=new $(this.db)}return t.prototype.create=function(r){return l(this,void 0,void 0,function(){var e,n;return D(this,function(t){switch(t.label){case 0:return[4,this.validator.validate(r,this.metadata)];case 1:return t.sent(),e=this.hydrator.dehydrate(r,this.metadata),[4,this.db.put(e)];case 2:return n=t.sent(),U(r,n),[2,r]}})})},t.prototype.upsert=function(r){return l(this,void 0,void 0,function(){var e,n;return D(this,function(t){switch(t.label){case 0:return[4,this.validator.validate(r,this.metadata)];case 1:return t.sent(),e=this.hydrator.dehydrate(r,this.metadata),[4,this._upsert(this.id.build(this.metadata.name,this.metadata.idType,r[this.metadata.id]),e)];case 2:return n=t.sent(),U(r,n),[2,r]}})})},t.prototype._upsert=function(t,o){var a=this;return this.db.upsert(t,function(t){var e=o,n=(e._id,e._rev,M(e,["_id","_rev"])),r=t,i=(r._id,r._rev,M(r,["_id","_rev"]));return!a.equal(n,i)&&o})},t.prototype.update=function(r){return l(this,void 0,void 0,function(){var e,n;return D(this,function(t){switch(t.label){case 0:return[4,this.validator.validate(r,this.metadata)];case 1:return t.sent(),e=this.hydrator.dehydrate(r,this.metadata,{includeRev:!0}),[4,this.db.put(e)];case 2:return n=t.sent(),U(r,n),[2,r]}})})},t.prototype["delete"]=function(r){return l(this,void 0,void 0,function(){var e,n;return D(this,function(t){switch(t.label){case 0:return[4,this.validator.validate(r,this.metadata)];case 1:return t.sent(),(e=this.hydrator.dehydrate(r,this.metadata,{includeRev:!0}))._deleted=!0,[4,this.db.put(e)];case 2:return n=t.sent(),U(r,n),H(r),[2,r]}})})},t.prototype.read=function(t,e){return this._read(this.id.build(this.metadata.name,this.metadata.idType,t),e)},t.prototype._read=function(i,o){return l(this,void 0,void 0,function(){var e,n,r;return D(this,function(t){switch(t.label){case 0:return n=(e=this.hydrator).hydrate,r=[Object.create(this.entityClass.prototype)],[4,this._readRaw(i)];case 1:return[2,n.apply(e,r.concat([t.sent(),this.metadata,o]))]}})})},t.prototype._readRaw=function(n){return l(this,void 0,void 0,function(){var e;return D(this,function(t){switch(t.label){case 0:return[4,this.queryBatcher.read([n])];case 1:if(!(e=t.sent())[0])throw{status:404,name:"not_found",message:"missing",reason:"missing",id:n};return[2,e[0]]}})})},t.prototype.readAll=function(r,i){return l(this,void 0,void 0,function(){var e,n=this;return D(this,function(t){return e={include_docs:!0},r?e.keys=r.map(function(t){return n.id.build(n.metadata.name,n.metadata.idType,t)}).sort(function(t,e){return t.localeCompare(e)}):(e.startkey=this.id.head(this.metadata.name),e.endkey=this.id.tail(this.metadata.name)),[2,this._readAll(e,i)]})})},t.prototype._readAll=function(i,o){return l(this,void 0,void 0,function(){var e,n,r=this;return D(this,function(t){switch(t.label){case 0:return n=(e=Promise).all,[4,this._readAllRaw(i)];case 1:return[4,n.apply(e,[t.sent().map(function(e){return l(r,void 0,void 0,function(){return D(this,function(t){return[2,this.hydrator.hydrate(Object.create(this.entityClass.prototype),e,this.metadata,o)]})})})])];case 2:return[2,t.sent()]}})})},t.prototype._readAllRaw=function(e){return l(this,void 0,void 0,function(){return D(this,function(t){switch(t.label){case 0:return e.include_docs&&"keys"in e?[4,this.queryBatcher.read(e.keys)]:[3,2];case 1:return[2,t.sent()];case 2:return[4,this.db.allDocs(e)];case 3:return[2,t.sent().rows.map(function(t){return t.doc}).filter(Boolean)]}})})},t.prototype.query=function(){return new J(this,this.id.head(this.metadata.name),this.id.tail(this.metadata.name))},t.prototype.executeQuery=function(i,o){return l(this,void 0,void 0,function(){var e,n,r=this;return D(this,function(t){switch(t.label){case 0:return n=(e=Promise).all,[4,this.db.find(i.toFindRequest())];case 1:return[4,n.apply(e,[t.sent().docs.map(function(e){return l(r,void 0,void 0,function(){return D(this,function(t){return[2,this.hydrator.hydrate(Object.create(this.entityClass.prototype),e,this.metadata,o)]})})})])];case 2:return[2,t.sent()]}})})},t.prototype.build=function(t){return void 0===t&&(t={}),d(Object.create(this.entityClass.prototype),t)},t.prototype.persistDesignDoc=function(g){return l(this,void 0,void 0,function(){var r,i,o,a,s,u,c,d,l,f,h,p,y,v,w,m,b,_=this;return D(this,function(t){switch(t.label){case 0:if(s=j(g.constructor,I),u=O(g.constructor),1!==s.length)throw new Error("Design doc annotation required");if(s[0].entity!==this.entityClass)throw new Error("Invalid design doc entity");c={_id:"_design/"+s[0].name,views:{},filters:{}};try{for(d=E(u),l=d.next();!l.done;l=d.next()){f=A(l.value,2),h=f[0],p=f[1];try{for(y=E(p),v=y.next();!v.done;v=y.next())(w=v.value)instanceof V?(m=g[h],"string"===(b=typeof m)||"function"===b?c.views[h]={map:m.toString()}:"object"===b&&(c.views[h]={map:m.map.toString(),reduce:m.reduce&&m.reduce.toString()})):w instanceof T?c.filters[h]=g[h].toString():w instanceof k&&(c.validate_doc_update=g[h].toString())}catch(e){o={error:e}}finally{try{v&&!v.done&&(a=y["return"])&&a.call(y)}finally{if(o)throw o.error}}}}catch(n){r={error:n}}finally{try{l&&!l.done&&(i=d["return"])&&i.call(d)}finally{if(r)throw r.error}}return[4,this.db.upsert(c._id,function(t){var e=c,n=(e._id,e._rev,M(e,["_id","_rev"])),r=t,i=(r._id,r._rev,M(r,["_id","_rev"]));return!_.equal(n,i)&&c})];case 1:return t.sent(),[2]}})})},t.prototype.view=function(a,s,t){void 0===t&&(t={});var u=t.depth,c=t.circularCache,d=M(t,["depth","circularCache"]);return l(this,void 0,void 0,function(){var e,n,i,o=this;return D(this,function(t){switch(t.label){case 0:if(!(e=j(a,I)[0]))throw new Error("Design doc annotation required");if(e.entity!==this.entityClass)throw new Error("Invalid design doc entity");if(!function r(t,e,n){return f.has(t)&&f.get(t).has(e)?f.get(t).get(e).filter(function(t){return!n||t instanceof n}):[]}(a,s,V))throw new Error('Unknown view "'+s+'"');return d||(d={}),d.include_docs=!0,i=(n=Promise).all,[4,this.rawView(e.name+"/"+s,d)];case 1:return[4,i.apply(n,[t.sent().rows.map(function(t){return t.doc}).map(function(e){return l(o,void 0,void 0,function(){return D(this,function(t){return[2,this.hydrator.hydrate(Object.create(this.entityClass.prototype),e,this.metadata,{depth:u,circularCache:c})]})})})])];case 2:return[2,t.sent()]}})})},t.prototype.rawView=function(t,e){return this.db.query(t,e)},t.decorators=[{type:i.Injectable}],t.ctorParameters=function(){return[{type:undefined,decorators:[{type:i.Inject,args:[v]}]},{type:undefined,decorators:[{type:i.Inject,args:[w]}]},{type:Y,decorators:[{type:i.Inject,args:[m]}]},{type:undefined,decorators:[{type:i.Inject,args:[b]}]},{type:undefined,decorators:[{type:i.Inject,args:[B]}]},{type:L},{type:p},{type:y}]},t}(),G=function(r){function t(t,e){var n=r.call(this)||this;return n.id=t,n.connectionManager=e,n}return o(t,r),t.prototype.dehydrate=function(a,s,t){var e,n,u=this,c={};t&&t.includeRev&&(c._rev=a._rev),s.attachments&&a._attachments&&(c._attachments=a._attachments);var r=function(t,e){var n=a[t];if(e instanceof q){if(null!=n){var r=d.connectionManager.getMetadata(e.type);if(e instanceof P)c[t]=X(n,r,d.id);else if(e instanceof S)c[t]=n.map(function(t){return X(t,r,u.id)});else if(e instanceof R){var i={};for(var o in n)i[o]=X(n[o],r,d.id);c[t]=i}else e instanceof F&&(c[t]=d.connectionManager.getRepository(e.type).hydrator.dehydrate(n,r))}}else e instanceof N&&(c[t]=n,e instanceof C&&(c._id=d.id.build(s.name,s.idType,n)));undefined===c[t]&&delete c[t]},d=this;try{for(var i=E(s.properties),o=i.next();!o.done;o=i.next()){var l=A(o.value,2);r(l[0],l[1])}}catch(f){e={error:f}}finally{try{o&&!o.done&&(n=i["return"])&&n.call(i)}finally{if(e)throw e.error}}return c},t.prototype.hydrate=function(T,C,d,t){var e=void 0===t?{}:t,n=e.depth,x=void 0===n?Infinity:n,r=e.circularCache,k=void 0===r?{}:r;return l(this,void 0,void 0,function(){var e,n,r,I,i,o,a,s,u,c;return D(this,function(t){switch(t.label){case 0:if(C._id in k)return[2,k[C._id]];U(k[C._id]=T,{id:C._id,rev:C._rev}),d.attachments&&Object.defineProperty(T,"_attachments",{configurable:!0,value:C._attachments}),r=function(r,i){var o,a,s,u,c,d,l,f,h,p,y,v,w,m,b,_,g,M,A,j,O;return D(this,function(t){switch(t.label){case 0:return null!=(s=C[r])?[3,1]:(T[r]=null,[3,13]);case 1:return i instanceof q?(u=I.connectionManager.getMetadata(i.type),c=I.connectionManager.getRepository(i.type),i instanceof P?(d=T,l=r,k.hasOwnProperty(s)?(f=k[s],[3,4]):[3,2]):[3,5]):[3,12];case 2:return[4,c._read(s,{depth:x-1,circularCache:k})];case 3:f=t.sent(),t.label=4;case 4:return d[l]=f,[3,11];case 5:return i instanceof S?(h=T,p=r,[4,z(c,s,x-1,k)]):[3,7];case 6:return h[p]=t.sent(),[3,11];case 7:return i instanceof R?(y=Object.keys(s),v=y.map(function(t){return s[t]}),[4,z(c,v,x-1,k)]):[3,9];case 8:w=t.sent(),m={},b=function(e){m[e]=w.find(function(t){return t._id===s[e]})};try{for(_=E(y),g=_.next();!g.done;g=_.next())M=g.value,b(M)}catch(e){o={error:e}}finally{try{g&&!g.done&&(a=_["return"])&&a.call(_)}finally{if(o)throw o.error}}return T[r]=m,[3,11];case 9:return i instanceof F?(A=T,j=r,[4,c.hydrator.hydrate(c.build(),s,u)]):[3,11];case 10:A[j]=t.sent(),t.label=11;case 11:return[3,13];case 12:i instanceof N&&(!(O=Object.getOwnPropertyDescriptor(Object.getPrototypeOf(T),r))||O.writable||O.set)&&(T[r]=function n(t,e){if(e===Date&&t)return new Date(t);return t}(s,i.type)),t.label=13;case 13:return[2]}})},I=this,t.label=1;case 1:t.trys.push([1,6,7,8]),i=E(d.properties),o=i.next(),t.label=2;case 2:return o.done?[3,5]:(a=A(o.value,2),s=a[0],u=a[1],[5,r(s,u)]);case 3:t.sent(),t.label=4;case 4:return o=i.next(),[3,2];case 5:return[3,8];case 6:return c=t.sent(),e={error:c},[3,8];case 7:try{o&&!o.done&&(n=i["return"])&&n.call(i)}finally{if(e)throw e.error}return[7];case 8:return[2,T]}})})},t.decorators=[{type:i.Injectable}],t.ctorParameters=function(){return[{type:undefined,decorators:[{type:i.Inject,args:[B]}]},{type:et}]},t}(p);function z(r,i,o,a){return l(this,void 0,void 0,function(){var e,n;return D(this,function(t){switch(t.label){case 0:return(e=i.filter(function(t){return!a.hasOwnProperty(t)})).length?[4,r._readAll({keys:e,include_docs:!0},{depth:o,circularCache:a})]:[3,2];case 1:n=t.sent(),t.label=2;case 2:return[2,i.map(function(e){return a.hasOwnProperty(e)?a[e]:n&&n.find(function(t){return t._id===e})})]}})})}function X(t,e,n){return"string"==typeof t?t:n.build(e.name,e.idType,t[e.id])}var Z=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return o(e,t),e.prototype.validate=function(u,c){return l(this,void 0,void 0,function(){var e,n,r,i,o,a,s;return D(this,function(t){switch(t.label){case 0:t.trys.push([0,5,6,7]),r=E(c.properties),i=r.next(),t.label=1;case 1:return i.done?[3,4]:(o=A(i.value,2),a=o[0],[4,o[1].validate(u[a],a)]);case 2:t.sent(),t.label=3;case 3:return i=r.next(),[3,1];case 4:return[3,7];case 5:return s=t.sent(),e={error:s},[3,7];case 6:try{i&&!i.done&&(n=r["return"])&&n.call(r)}finally{if(e)throw e.error}return[7];case 7:return[2,!0]}})})},e}(y);function tt(){return{head:function(t){return t+"_0"},tail:function(t){return t+"_9"},build:function(t,e,n){if(e===String)return t+"_2_"+n;if(e!==Number)throw new Error('Invalid id type "'+e+'"');var r=n.toString();return t+"_1_"+"0".repeat(16-r.length)+r},parse:function(t){var e=/^(.*)_(1|2)_(.*)$/.exec(t);if(!e)throw new TypeError('Invalid id "'+t+'"');return{name:e[1],type:"2"===e[2]?String:Number,id:"2"===e[2]?e[3]:Number.parseInt(e[3],10)}}}}var et=function(){function n(t,e,n){this.connectionFactory=t,this.id=e,this.injector=n,this.connections=new Map,this.repositories=new Map,this.metadata=new Map}return n.prototype.getOpenConnections=function(){return Array.from(this.connections.values())},n.prototype.getConnection=function(t){return this.connections.has(t)||this.connections.set(t,this.createConnection(t)),this.connections.get(t)},n.prototype.clearConnections=function(){this.connections.clear()},n.prototype.createConnection=function(t){return this.connectionFactory(t)},n.prototype.getRepository=function(t){return this.repositories.has(t)||this.repositories.set(t,this.createRepository(t)),this.repositories.get(t)},n.prototype.createRepository=function(t){var e=this.getMetadata(t);return i.Injector.create({parent:this.injector,providers:[{provide:n,useValue:this},{provide:W,deps:[v,w,m,b,B,L,p,y]},{provide:w,useValue:t},{provide:m,useValue:e},{provide:v,useValue:e.inline?null:this.getConnection(e.name)},{provide:G,deps:[B,n]},{provide:Z,deps:[]},{provide:p,useExisting:e.hydrator||G},{provide:y,useExisting:e.validator||Z},{provide:L,deps:[v,w,m,p,y]}]}).get(W)},n.prototype.getMetadata=function(t){return this.metadata.has(t)||this.metadata.set(t,this.createMetadata(t)),this.metadata.get(t)},n.prototype.createMetadata=function(t){return new Y(t)},n.decorators=[{type:i.Injectable}],n.ctorParameters=function(){return[{type:undefined,decorators:[{type:i.Inject,args:[_]}]},{type:undefined,decorators:[{type:i.Inject,args:[B]}]},{type:i.Injector}]},n}();t.BelongsTo=function dt(n){return void 0===n&&(n={}),function(t,e){c(t.constructor,e,d(new P,a({type:Reflect.getMetadata("design:type",t,e),required:!1},n)))}},t.BelongsToMetadata=P,t.DesignDoc=function lt(e,n){return function(t){u(t,d(new I,{entity:e,name:n}))}},t.DesignDocMetadata=I,t.Entity=function ft(e,n){return void 0===n&&(n={}),function(t){u(t,d(new g,a({name:e,attachments:!1},n)))}},t.EntityMetadata=g,t.Filter=function ht(){return function(t,e){c(t.constructor,e,d(new T,{}))}},t.FilterMetadata=T,t.HasMany=function pt(n,r){return void 0===r&&(r={}),function(t,e){c(t.constructor,e,d(new S,a({type:n,required:!1},r)))}},t.HasManyMetadata=S,t.HasManyMap=function yt(n,r){return void 0===r&&(r={}),function(t,e){c(t.constructor,e,d(new R,a({type:n,required:!1},r)))}},t.HasManyMapMetadata=R,t.Id=function vt(n){return void 0===n&&(n={}),function(t,e){c(t.constructor,e,d(new C,a({strategy:h.Static,type:Reflect.getMetadata("design:type",t,e)},n)))}},t.IdStrategy=h,t.IdMetadata=C,t.Inline=function wt(n){return void 0===n&&(n={}),function(t,e){c(t.constructor,e,d(new F,a({type:Reflect.getMetadata("design:type",t,e),required:!1},n)))}},t.InlineMetadata=F,t.InlineEntity=function mt(e){return void 0===e&&(e={}),function(t){u(t,d(new x,a({},e,{inline:!0})))}},t.InlineEntityMetadata=x,t.Property=function bt(n){return void 0===n&&(n={}),function(t,e){c(t.constructor,e,d(new N,a({type:Reflect.getMetadata("design:type",t,e),required:!1},n)))}},t.PropertyMetadata=N,t.RelationMetadata=q,t.ValidateDoc=function _t(){return function(t,e){c(t.constructor,e,d(new k,{}))}},t.ValidateDocMetadata=k,t.View=function gt(){return function(t,e){c(t.constructor,e,d(new V,{}))}},t.ViewMetadata=V,t.BulkOperation=Q,t.Bulk=L,t.adamantIdFactory=tt,t.createAdamantConnection=function Mt(t){return i.Injector.create({providers:[{provide:_,useValue:t},{provide:et,deps:[_,B,i.Injector]},{provide:B,useFactory:tt,deps:[]},{provide:b,useFactory:K,deps:[]}]}).get(et)},t.AdamantConnectionManager=et,t.Hydrator=p,t.HydratorImpl=G,t.ADAMANT_CONNECTION=v,t.ADAMANT_ENTITY_CLASS=w,t.ADAMANT_ENTITY_METADATA=m,t.ADAMANT_EQUAL_CHECKER=b,t.ADAMANT_CONNECTION_FACTORY=_,t.ADAMANT_ID=B,t.Metadata=Y,t.QueryBuilder=J,t.equalCheckerFactory=K,t.AdamantRepository=W,t.Validator=y,t.ValidatorImpl=Z,Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=neoskop-adamant.umd.min.js.map