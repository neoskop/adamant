/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,uselessCode} checked by tsc
 */
import { Inject, Injectable, Injector } from '@angular/core';
import { AdamantRepository, equalCheckerFactory } from './repository';
import { Metadata } from './metadata';
import { Bulk } from './bulk';
import { Hydrator } from './hydrator';
import { Validator } from './validator';
import { HydratorImpl } from './hydrator-impl';
import { ValidatorImpl } from './validator-impl';
import { ADAMANT_CONNECTION, ADAMANT_CONNECTION_FACTORY, ADAMANT_ENTITY_CLASS, ADAMANT_ENTITY_METADATA, ADAMANT_EQUAL_CHECKER, ADAMANT_ID } from './injector-tokens';
/**
 * @return {?}
 */
export function adamantIdFactory() {
    return {
        /**
         * @param {?} name
         * @return {?}
         */
        head(name) {
            return `${name}_0`;
        },
        /**
         * @param {?} name
         * @return {?}
         */
        tail(name) {
            return `${name}_9`;
        },
        /**
         * @param {?} name
         * @param {?} type
         * @param {?} id
         * @return {?}
         */
        build(name, type, id) {
            if (type === String) {
                return `${name}_2_${id}`;
            }
            else if (type === Number) {
                /** @type {?} */
                const idStr = id.toString();
                return `${name}_1_${'0'.repeat(16 - idStr.length)}${idStr}`;
            }
            throw new Error(`Invalid id type "${type}"`);
        },
        /**
         * @param {?} id
         * @return {?}
         */
        parse(id) {
            /** @type {?} */
            const match = /^(.*)_(1|2)_(.*)$/.exec(id);
            if (!match) {
                throw new TypeError(`Invalid id "${id}"`);
            }
            return {
                name: /** @type {?} */ ((match[1])),
                type: match[2] === '2' ? String : Number,
                id: match[2] === '2' ? match[3] : Number.parseInt(match[3], 10)
            };
        }
    };
}
/**
 * @param {?} factory
 * @return {?}
 */
export function createAdamantConnection(factory) {
    /** @type {?} */
    const injector = Injector.create({
        providers: [
            { provide: ADAMANT_CONNECTION_FACTORY, useValue: factory },
            { provide: AdamantConnectionManager, deps: [ADAMANT_CONNECTION_FACTORY, ADAMANT_ID, Injector] },
            { provide: ADAMANT_ID, useFactory: adamantIdFactory, deps: [] },
            { provide: ADAMANT_EQUAL_CHECKER, useFactory: equalCheckerFactory, deps: [] }
        ]
    });
    return injector.get(AdamantConnectionManager);
}
export class AdamantConnectionManager {
    /**
     * @param {?} connectionFactory
     * @param {?} id
     * @param {?} injector
     */
    constructor(connectionFactory, id, injector) {
        this.connectionFactory = connectionFactory;
        this.id = id;
        this.injector = injector;
        this.connections = new Map();
        this.repositories = new Map();
        this.metadata = new Map();
    }
    /**
     * @return {?}
     */
    getOpenConnections() {
        return Array.from(this.connections.values());
    }
    /**
     * @template T
     * @param {?} name
     * @return {?}
     */
    getConnection(name) {
        if (!this.connections.has(name)) {
            this.connections.set(name, this.createConnection(name));
        }
        return /** @type {?} */ ((this.connections.get(name)));
    }
    /**
     * @return {?}
     */
    clearConnections() {
        this.connections.clear();
    }
    /**
     * @param {?} name
     * @return {?}
     */
    createConnection(name) {
        return this.connectionFactory(name);
    }
    /**
     * @template T
     * @param {?} entityClass
     * @return {?}
     */
    getRepository(entityClass) {
        if (!this.repositories.has(entityClass)) {
            this.repositories.set(entityClass, this.createRepository(entityClass));
        }
        return /** @type {?} */ ((this.repositories.get(entityClass)));
    }
    /**
     * @template T
     * @param {?} entityClass
     * @return {?}
     */
    createRepository(entityClass) {
        /** @type {?} */
        const metadata = this.getMetadata(entityClass);
        return Injector.create({
            parent: this.injector,
            providers: [
                { provide: AdamantConnectionManager, useValue: this },
                { provide: AdamantRepository, deps: [ADAMANT_CONNECTION, ADAMANT_ENTITY_CLASS, ADAMANT_ENTITY_METADATA, ADAMANT_EQUAL_CHECKER, ADAMANT_ID, Bulk, Hydrator, Validator] },
                { provide: ADAMANT_ENTITY_CLASS, useValue: entityClass },
                { provide: ADAMANT_ENTITY_METADATA, useValue: metadata, },
                { provide: ADAMANT_CONNECTION, useValue: !metadata.inline ? this.getConnection(/** @type {?} */ ((metadata.name))) : null },
                { provide: HydratorImpl, deps: [ADAMANT_ID, AdamantConnectionManager] },
                { provide: ValidatorImpl, deps: [] },
                { provide: Hydrator, useExisting: metadata.hydrator || HydratorImpl },
                { provide: Validator, useExisting: metadata.validator || ValidatorImpl },
                { provide: Bulk, deps: [ADAMANT_CONNECTION, ADAMANT_ENTITY_CLASS, ADAMANT_ENTITY_METADATA, Hydrator, Validator] }
            ]
        }).get(AdamantRepository);
    }
    /**
     * @template T
     * @param {?} entityClass
     * @return {?}
     */
    getMetadata(entityClass) {
        if (!this.metadata.has(entityClass)) {
            this.metadata.set(entityClass, this.createMetadata(entityClass));
        }
        return /** @type {?} */ ((this.metadata.get(entityClass)));
    }
    /**
     * @template T
     * @param {?} entityClass
     * @return {?}
     */
    createMetadata(entityClass) {
        return new Metadata(entityClass);
    }
}
AdamantConnectionManager.decorators = [
    { type: Injectable }
];
/** @nocollapse */
AdamantConnectionManager.ctorParameters = () => [
    { type: undefined, decorators: [{ type: Inject, args: [ADAMANT_CONNECTION_FACTORY,] }] },
    { type: undefined, decorators: [{ type: Inject, args: [ADAMANT_ID,] }] },
    { type: Injector }
];
if (false) {
    /** @type {?} */
    AdamantConnectionManager.prototype.connections;
    /** @type {?} */
    AdamantConnectionManager.prototype.repositories;
    /** @type {?} */
    AdamantConnectionManager.prototype.metadata;
    /** @type {?} */
    AdamantConnectionManager.prototype.connectionFactory;
    /** @type {?} */
    AdamantConnectionManager.prototype.id;
    /** @type {?} */
    AdamantConnectionManager.prototype.injector;
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29ubmVjdGlvbi1tYW5hZ2VyLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQG5lb3Nrb3AvYWRhbWFudC8iLCJzb3VyY2VzIjpbImNvbm5lY3Rpb24tbWFuYWdlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzdELE9BQU8sRUFDSCxpQkFBaUIsRUFBRSxtQkFBbUIsRUFDekMsTUFBTSxjQUFjLENBQUM7QUFFdEIsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLFlBQVksQ0FBQztBQUN0QyxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sUUFBUSxDQUFDO0FBQzlCLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxZQUFZLENBQUM7QUFDdEMsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUN4QyxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDL0MsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQ2pELE9BQU8sRUFDSCxrQkFBa0IsRUFDbEIsMEJBQTBCLEVBQUUsb0JBQW9CLEVBQUUsdUJBQXVCLEVBQ3pFLHFCQUFxQixFQUNyQixVQUFVLEVBR2IsTUFBTSxtQkFBbUIsQ0FBQzs7OztBQUkzQixNQUFNO0lBQ0YsT0FBTzs7Ozs7UUFDSCxJQUFJLENBQUMsSUFBYTtZQUNkLE9BQU8sR0FBRyxJQUFJLElBQUksQ0FBQTtTQUNyQjs7Ozs7UUFDRCxJQUFJLENBQUMsSUFBYTtZQUNkLE9BQU8sR0FBRyxJQUFJLElBQUksQ0FBQTtTQUNyQjs7Ozs7OztRQUNELEtBQUssQ0FBQyxJQUFhLEVBQUUsSUFBb0MsRUFBRSxFQUFrQjtZQUN6RSxJQUFHLElBQUksS0FBSyxNQUFNLEVBQUU7Z0JBQ2hCLE9BQU8sR0FBRyxJQUFJLE1BQU0sRUFBRSxFQUFFLENBQUM7YUFDNUI7aUJBQU0sSUFBRyxJQUFJLEtBQUssTUFBTSxFQUFFOztnQkFDdkIsTUFBTSxLQUFLLEdBQUcsRUFBRSxDQUFDLFFBQVEsRUFBRSxDQUFDO2dCQUM1QixPQUFPLEdBQUcsSUFBSSxNQUFNLEdBQUcsQ0FBQyxNQUFNLENBQUMsRUFBRSxHQUFHLEtBQUssQ0FBQyxNQUFNLENBQUMsR0FBRyxLQUFLLEVBQUUsQ0FBQzthQUMvRDtZQUNELE1BQU0sSUFBSSxLQUFLLENBQUMsb0JBQW9CLElBQUksR0FBRyxDQUFDLENBQUM7U0FDaEQ7Ozs7O1FBQ0QsS0FBSyxDQUFDLEVBQVc7O1lBQ2IsTUFBTSxLQUFLLEdBQUcsbUJBQW1CLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1lBRTNDLElBQUcsQ0FBQyxLQUFLLEVBQUU7Z0JBQ1AsTUFBTSxJQUFJLFNBQVMsQ0FBQyxlQUFlLEVBQUUsR0FBRyxDQUFDLENBQUM7YUFDN0M7WUFFRCxPQUFPO2dCQUNILElBQUkscUJBQUUsS0FBSyxDQUFDLENBQUMsQ0FBQyxFQUFDO2dCQUNmLElBQUksRUFBRSxLQUFLLENBQUMsQ0FBQyxDQUFDLEtBQUssR0FBRyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLE1BQU07Z0JBQ3hDLEVBQUUsRUFBRSxLQUFLLENBQUMsQ0FBQyxDQUFDLEtBQUssR0FBRyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQzthQUNsRSxDQUFDO1NBQ0w7S0FDSixDQUFBO0NBQ0o7Ozs7O0FBR0QsTUFBTSxrQ0FBa0MsT0FBMkI7O0lBQy9ELE1BQU0sUUFBUSxHQUFHLFFBQVEsQ0FBQyxNQUFNLENBQUM7UUFDN0IsU0FBUyxFQUFFO1lBQ1AsRUFBRSxPQUFPLEVBQUUsMEJBQTBCLEVBQUUsUUFBUSxFQUFFLE9BQU8sRUFBRTtZQUMxRCxFQUFFLE9BQU8sRUFBRSx3QkFBd0IsRUFBRSxJQUFJLEVBQUUsQ0FBRSwwQkFBMEIsRUFBRSxVQUFVLEVBQUUsUUFBUSxDQUFFLEVBQUU7WUFDakcsRUFBRSxPQUFPLEVBQUUsVUFBVSxFQUFFLFVBQVUsRUFBRSxnQkFBZ0IsRUFBRSxJQUFJLEVBQUUsRUFBRSxFQUFFO1lBQy9ELEVBQUUsT0FBTyxFQUFFLHFCQUFxQixFQUFFLFVBQVUsRUFBRSxtQkFBbUIsRUFBRSxJQUFJLEVBQUUsRUFBRSxFQUFFO1NBQ2hGO0tBQ0osQ0FBQyxDQUFDO0lBRUgsT0FBTyxRQUFRLENBQUMsR0FBRyxDQUFDLHdCQUF3QixDQUFDLENBQUM7Q0FDakQ7QUFHRCxNQUFNOzs7Ozs7SUFNRixZQUFtRSxpQkFBcUMsRUFDeEQsRUFBYyxFQUMvQixRQUFtQjtRQUZpQixzQkFBaUIsR0FBakIsaUJBQWlCLENBQW9CO1FBQ3hELE9BQUUsR0FBRixFQUFFLENBQVk7UUFDL0IsYUFBUSxHQUFSLFFBQVEsQ0FBVzsyQkFOakIsSUFBSSxHQUFHLEVBQWlDOzRCQUN2QyxJQUFJLEdBQUcsRUFBcUM7d0JBQ2hELElBQUksR0FBRyxFQUE0QjtLQUlYOzs7O0lBRXRELGtCQUFrQjtRQUNkLE9BQU8sS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUM7S0FDaEQ7Ozs7OztJQUVELGFBQWEsQ0FBb0IsSUFBYTtRQUMxQyxJQUFHLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUU7WUFDNUIsSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1NBQzNEO1FBRUQsMEJBQU8sSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEdBQUU7S0FDdEM7Ozs7SUFFRCxnQkFBZ0I7UUFDWixJQUFJLENBQUMsV0FBVyxDQUFDLEtBQUssRUFBRSxDQUFDO0tBQzVCOzs7OztJQUVTLGdCQUFnQixDQUFDLElBQWE7UUFDcEMsT0FBTyxJQUFJLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLENBQUM7S0FDdkM7Ozs7OztJQUVELGFBQWEsQ0FBSSxXQUFxQjtRQUNsQyxJQUFHLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxHQUFHLENBQUMsV0FBVyxDQUFDLEVBQUU7WUFDcEMsSUFBSSxDQUFDLFlBQVksQ0FBQyxHQUFHLENBQUMsV0FBVyxFQUFFLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDO1NBQzFFO1FBRUQsMEJBQU8sSUFBSSxDQUFDLFlBQVksQ0FBQyxHQUFHLENBQUMsV0FBVyxDQUFDLEdBQUU7S0FDOUM7Ozs7OztJQUVTLGdCQUFnQixDQUFJLFdBQXFCOztRQUMvQyxNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBRS9DLE9BQU8sUUFBUSxDQUFDLE1BQU0sQ0FBQztZQUNuQixNQUFNLEVBQUUsSUFBSSxDQUFDLFFBQVE7WUFDckIsU0FBUyxFQUFFO2dCQUNQLEVBQUUsT0FBTyxFQUFFLHdCQUF3QixFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUU7Z0JBQ3JELEVBQUUsT0FBTyxFQUFFLGlCQUFpQixFQUFFLElBQUksRUFBRSxDQUFFLGtCQUFrQixFQUFFLG9CQUFvQixFQUFFLHVCQUF1QixFQUFFLHFCQUFxQixFQUFFLFVBQVUsRUFBRSxJQUFJLEVBQUUsUUFBUSxFQUFFLFNBQVMsQ0FBQyxFQUFFO2dCQUN4SyxFQUFFLE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxRQUFRLEVBQUUsV0FBVyxFQUFFO2dCQUN4RCxFQUFFLE9BQU8sRUFBRSx1QkFBdUIsRUFBRSxRQUFRLEVBQUUsUUFBUSxHQUFHO2dCQUN6RCxFQUFFLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxRQUFRLEVBQUUsQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsYUFBYSxvQkFBQyxRQUFRLENBQUMsSUFBSSxHQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksRUFBRTtnQkFDdkcsRUFBRSxPQUFPLEVBQUUsWUFBWSxFQUFFLElBQUksRUFBRSxDQUFFLFVBQVUsRUFBRSx3QkFBd0IsQ0FBQyxFQUFFO2dCQUN4RSxFQUFFLE9BQU8sRUFBRSxhQUFhLEVBQUUsSUFBSSxFQUFFLEVBQUUsRUFBRTtnQkFDcEMsRUFBRSxPQUFPLEVBQUUsUUFBUSxFQUFFLFdBQVcsRUFBRSxRQUFRLENBQUMsUUFBUSxJQUFJLFlBQVksRUFBRTtnQkFDckUsRUFBRSxPQUFPLEVBQUUsU0FBUyxFQUFFLFdBQVcsRUFBRSxRQUFRLENBQUMsU0FBUyxJQUFJLGFBQWEsRUFBRTtnQkFDeEUsRUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxDQUFFLGtCQUFrQixFQUFFLG9CQUFvQixFQUFFLHVCQUF1QixFQUFFLFFBQVEsRUFBRSxTQUFTLENBQUUsRUFBRTthQUN0SDtTQUNKLENBQUMsQ0FBQyxHQUFHLENBQXVCLGlCQUFpQixDQUFDLENBQUM7S0FDbkQ7Ozs7OztJQUVELFdBQVcsQ0FBSSxXQUFxQjtRQUNoQyxJQUFHLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsV0FBVyxDQUFDLEVBQUU7WUFDaEMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsV0FBVyxFQUFFLElBQUksQ0FBQyxjQUFjLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQztTQUNwRTtRQUVELDBCQUFPLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLFdBQVcsQ0FBQyxHQUFFO0tBQzFDOzs7Ozs7SUFFUyxjQUFjLENBQUksV0FBcUI7UUFDN0MsT0FBTyxJQUFJLFFBQVEsQ0FBSSxXQUFXLENBQUMsQ0FBQztLQUN2Qzs7O1lBckVKLFVBQVU7Ozs7NENBT00sTUFBTSxTQUFDLDBCQUEwQjs0Q0FDakMsTUFBTSxTQUFDLFVBQVU7WUE3RUwsUUFBUSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdCwgSW5qZWN0YWJsZSwgSW5qZWN0b3IgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7XG4gICAgQWRhbWFudFJlcG9zaXRvcnksIGVxdWFsQ2hlY2tlckZhY3Rvcnlcbn0gZnJvbSAnLi9yZXBvc2l0b3J5JztcbmltcG9ydCB7IEN0b3IgfSBmcm9tICcuL3V0aWxzL21ldGFkYXRhJztcbmltcG9ydCB7IE1ldGFkYXRhIH0gZnJvbSAnLi9tZXRhZGF0YSc7XG5pbXBvcnQgeyBCdWxrIH0gZnJvbSAnLi9idWxrJztcbmltcG9ydCB7IEh5ZHJhdG9yIH0gZnJvbSAnLi9oeWRyYXRvcic7XG5pbXBvcnQgeyBWYWxpZGF0b3IgfSBmcm9tICcuL3ZhbGlkYXRvcic7XG5pbXBvcnQgeyBIeWRyYXRvckltcGwgfSBmcm9tICcuL2h5ZHJhdG9yLWltcGwnO1xuaW1wb3J0IHsgVmFsaWRhdG9ySW1wbCB9IGZyb20gJy4vdmFsaWRhdG9yLWltcGwnO1xuaW1wb3J0IHtcbiAgICBBREFNQU5UX0NPTk5FQ1RJT04sXG4gICAgQURBTUFOVF9DT05ORUNUSU9OX0ZBQ1RPUlksIEFEQU1BTlRfRU5USVRZX0NMQVNTLCBBREFNQU5UX0VOVElUWV9NRVRBREFUQSxcbiAgICBBREFNQU5UX0VRVUFMX0NIRUNLRVIsXG4gICAgQURBTUFOVF9JRCxcbiAgICBBZGFtYW50SWQsXG4gICAgQ29ubmVjdGlvbkZhY3Rvcnlcbn0gZnJvbSAnLi9pbmplY3Rvci10b2tlbnMnO1xuXG5cblxuZXhwb3J0IGZ1bmN0aW9uIGFkYW1hbnRJZEZhY3RvcnkoKSA6IEFkYW1hbnRJZCB7XG4gICAgcmV0dXJuIHtcbiAgICAgICAgaGVhZChuYW1lIDogc3RyaW5nKSB7XG4gICAgICAgICAgICByZXR1cm4gYCR7bmFtZX1fMGBcbiAgICAgICAgfSxcbiAgICAgICAgdGFpbChuYW1lIDogc3RyaW5nKSB7XG4gICAgICAgICAgICByZXR1cm4gYCR7bmFtZX1fOWBcbiAgICAgICAgfSxcbiAgICAgICAgYnVpbGQobmFtZSA6IHN0cmluZywgdHlwZSA6IHR5cGVvZiBTdHJpbmcgfCB0eXBlb2YgTnVtYmVyLCBpZCA6IHN0cmluZ3xudW1iZXIpIDogc3RyaW5nIHtcbiAgICAgICAgICAgIGlmKHR5cGUgPT09IFN0cmluZykge1xuICAgICAgICAgICAgICAgIHJldHVybiBgJHtuYW1lfV8yXyR7aWR9YDtcbiAgICAgICAgICAgIH0gZWxzZSBpZih0eXBlID09PSBOdW1iZXIpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBpZFN0ciA9IGlkLnRvU3RyaW5nKCk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGAke25hbWV9XzFfJHsnMCcucmVwZWF0KDE2IC0gaWRTdHIubGVuZ3RoKX0ke2lkU3RyfWA7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEludmFsaWQgaWQgdHlwZSBcIiR7dHlwZX1cImApO1xuICAgICAgICB9LFxuICAgICAgICBwYXJzZShpZCA6IHN0cmluZykgOiB7IG5hbWU6IHN0cmluZywgdHlwZTogdHlwZW9mIFN0cmluZyB8IHR5cGVvZiBOdW1iZXIsIGlkIDogc3RyaW5nIHwgbnVtYmVyIH0ge1xuICAgICAgICAgICAgY29uc3QgbWF0Y2ggPSAvXiguKilfKDF8MilfKC4qKSQvLmV4ZWMoaWQpO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBpZighbWF0Y2gpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKGBJbnZhbGlkIGlkIFwiJHtpZH1cImApO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgXG4gICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgIG5hbWU6IG1hdGNoWzFdISxcbiAgICAgICAgICAgICAgICB0eXBlOiBtYXRjaFsyXSA9PT0gJzInID8gU3RyaW5nIDogTnVtYmVyLFxuICAgICAgICAgICAgICAgIGlkOiBtYXRjaFsyXSA9PT0gJzInID8gbWF0Y2hbM10gOiBOdW1iZXIucGFyc2VJbnQobWF0Y2hbM10sIDEwKVxuICAgICAgICAgICAgfTtcbiAgICAgICAgfVxuICAgIH1cbn1cblxuXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlQWRhbWFudENvbm5lY3Rpb24oZmFjdG9yeSA6IENvbm5lY3Rpb25GYWN0b3J5KSA6IEFkYW1hbnRDb25uZWN0aW9uTWFuYWdlciB7XG4gICAgY29uc3QgaW5qZWN0b3IgPSBJbmplY3Rvci5jcmVhdGUoe1xuICAgICAgICBwcm92aWRlcnM6IFtcbiAgICAgICAgICAgIHsgcHJvdmlkZTogQURBTUFOVF9DT05ORUNUSU9OX0ZBQ1RPUlksIHVzZVZhbHVlOiBmYWN0b3J5IH0sXG4gICAgICAgICAgICB7IHByb3ZpZGU6IEFkYW1hbnRDb25uZWN0aW9uTWFuYWdlciwgZGVwczogWyBBREFNQU5UX0NPTk5FQ1RJT05fRkFDVE9SWSwgQURBTUFOVF9JRCwgSW5qZWN0b3IgXSB9LFxuICAgICAgICAgICAgeyBwcm92aWRlOiBBREFNQU5UX0lELCB1c2VGYWN0b3J5OiBhZGFtYW50SWRGYWN0b3J5LCBkZXBzOiBbXSB9LFxuICAgICAgICAgICAgeyBwcm92aWRlOiBBREFNQU5UX0VRVUFMX0NIRUNLRVIsIHVzZUZhY3Rvcnk6IGVxdWFsQ2hlY2tlckZhY3RvcnksIGRlcHM6IFtdIH1cbiAgICAgICAgXVxuICAgIH0pO1xuXG4gICAgcmV0dXJuIGluamVjdG9yLmdldChBZGFtYW50Q29ubmVjdGlvbk1hbmFnZXIpO1xufVxuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgQWRhbWFudENvbm5lY3Rpb25NYW5hZ2VyIHtcbiAgICBcbiAgICBwcm90ZWN0ZWQgcmVhZG9ubHkgY29ubmVjdGlvbnMgPSBuZXcgTWFwPHN0cmluZywgUG91Y2hEQi5EYXRhYmFzZTxhbnk+PigpO1xuICAgIHByb3RlY3RlZCByZWFkb25seSByZXBvc2l0b3JpZXMgPSBuZXcgTWFwPEN0b3I8YW55PiwgQWRhbWFudFJlcG9zaXRvcnk8YW55Pj4oKTtcbiAgICBwcm90ZWN0ZWQgcmVhZG9ubHkgbWV0YWRhdGEgPSBuZXcgTWFwPEN0b3I8YW55PiwgTWV0YWRhdGE8YW55Pj4oKTtcbiAgICBcbiAgICBjb25zdHJ1Y3RvcihASW5qZWN0KEFEQU1BTlRfQ09OTkVDVElPTl9GQUNUT1JZKSBwcm90ZWN0ZWQgcmVhZG9ubHkgY29ubmVjdGlvbkZhY3RvcnkgOiBDb25uZWN0aW9uRmFjdG9yeSxcbiAgICAgICAgICAgICAgICBASW5qZWN0KEFEQU1BTlRfSUQpIHB1YmxpYyByZWFkb25seSBpZCA6IEFkYW1hbnRJZCxcbiAgICAgICAgICAgICAgICBwcm90ZWN0ZWQgcmVhZG9ubHkgaW5qZWN0b3IgOiBJbmplY3Rvcikge31cbiAgICBcbiAgICBnZXRPcGVuQ29ubmVjdGlvbnMoKSA6IFBvdWNoREIuRGF0YWJhc2VbXSB7XG4gICAgICAgIHJldHVybiBBcnJheS5mcm9tKHRoaXMuY29ubmVjdGlvbnMudmFsdWVzKCkpO1xuICAgIH1cbiAgICBcbiAgICBnZXRDb25uZWN0aW9uPFQgZXh0ZW5kcyB7fSA9IHt9PihuYW1lIDogc3RyaW5nKSA6IFBvdWNoREIuRGF0YWJhc2U8VD4ge1xuICAgICAgICBpZighdGhpcy5jb25uZWN0aW9ucy5oYXMobmFtZSkpIHtcbiAgICAgICAgICAgIHRoaXMuY29ubmVjdGlvbnMuc2V0KG5hbWUsIHRoaXMuY3JlYXRlQ29ubmVjdGlvbihuYW1lKSk7XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIHJldHVybiB0aGlzLmNvbm5lY3Rpb25zLmdldChuYW1lKSE7XG4gICAgfVxuICAgIFxuICAgIGNsZWFyQ29ubmVjdGlvbnMoKSB7XG4gICAgICAgIHRoaXMuY29ubmVjdGlvbnMuY2xlYXIoKTtcbiAgICB9XG4gICAgXG4gICAgcHJvdGVjdGVkIGNyZWF0ZUNvbm5lY3Rpb24obmFtZSA6IHN0cmluZykgOiBQb3VjaERCLkRhdGFiYXNlIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuY29ubmVjdGlvbkZhY3RvcnkobmFtZSk7XG4gICAgfVxuICAgIFxuICAgIGdldFJlcG9zaXRvcnk8VD4oZW50aXR5Q2xhc3MgOiBDdG9yPFQ+KSA6IEFkYW1hbnRSZXBvc2l0b3J5PFQ+IHtcbiAgICAgICAgaWYoIXRoaXMucmVwb3NpdG9yaWVzLmhhcyhlbnRpdHlDbGFzcykpIHtcbiAgICAgICAgICAgIHRoaXMucmVwb3NpdG9yaWVzLnNldChlbnRpdHlDbGFzcywgdGhpcy5jcmVhdGVSZXBvc2l0b3J5KGVudGl0eUNsYXNzKSk7XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIHJldHVybiB0aGlzLnJlcG9zaXRvcmllcy5nZXQoZW50aXR5Q2xhc3MpITtcbiAgICB9XG4gICAgXG4gICAgcHJvdGVjdGVkIGNyZWF0ZVJlcG9zaXRvcnk8VD4oZW50aXR5Q2xhc3MgOiBDdG9yPFQ+KSA6IEFkYW1hbnRSZXBvc2l0b3J5PFQ+IHtcbiAgICAgICAgY29uc3QgbWV0YWRhdGEgPSB0aGlzLmdldE1ldGFkYXRhKGVudGl0eUNsYXNzKTtcbiAgICAgICAgXG4gICAgICAgIHJldHVybiBJbmplY3Rvci5jcmVhdGUoe1xuICAgICAgICAgICAgcGFyZW50OiB0aGlzLmluamVjdG9yLFxuICAgICAgICAgICAgcHJvdmlkZXJzOiBbXG4gICAgICAgICAgICAgICAgeyBwcm92aWRlOiBBZGFtYW50Q29ubmVjdGlvbk1hbmFnZXIsIHVzZVZhbHVlOiB0aGlzIH0sXG4gICAgICAgICAgICAgICAgeyBwcm92aWRlOiBBZGFtYW50UmVwb3NpdG9yeSwgZGVwczogWyBBREFNQU5UX0NPTk5FQ1RJT04sIEFEQU1BTlRfRU5USVRZX0NMQVNTLCBBREFNQU5UX0VOVElUWV9NRVRBREFUQSwgQURBTUFOVF9FUVVBTF9DSEVDS0VSLCBBREFNQU5UX0lELCBCdWxrLCBIeWRyYXRvciwgVmFsaWRhdG9yXSB9LFxuICAgICAgICAgICAgICAgIHsgcHJvdmlkZTogQURBTUFOVF9FTlRJVFlfQ0xBU1MsIHVzZVZhbHVlOiBlbnRpdHlDbGFzcyB9LFxuICAgICAgICAgICAgICAgIHsgcHJvdmlkZTogQURBTUFOVF9FTlRJVFlfTUVUQURBVEEsIHVzZVZhbHVlOiBtZXRhZGF0YSwgfSxcbiAgICAgICAgICAgICAgICB7IHByb3ZpZGU6IEFEQU1BTlRfQ09OTkVDVElPTiwgdXNlVmFsdWU6ICFtZXRhZGF0YS5pbmxpbmUgPyB0aGlzLmdldENvbm5lY3Rpb24obWV0YWRhdGEubmFtZSEpIDogbnVsbCB9LFxuICAgICAgICAgICAgICAgIHsgcHJvdmlkZTogSHlkcmF0b3JJbXBsLCBkZXBzOiBbIEFEQU1BTlRfSUQsIEFkYW1hbnRDb25uZWN0aW9uTWFuYWdlcl0gfSxcbiAgICAgICAgICAgICAgICB7IHByb3ZpZGU6IFZhbGlkYXRvckltcGwsIGRlcHM6IFtdIH0sXG4gICAgICAgICAgICAgICAgeyBwcm92aWRlOiBIeWRyYXRvciwgdXNlRXhpc3Rpbmc6IG1ldGFkYXRhLmh5ZHJhdG9yIHx8IEh5ZHJhdG9ySW1wbCB9LFxuICAgICAgICAgICAgICAgIHsgcHJvdmlkZTogVmFsaWRhdG9yLCB1c2VFeGlzdGluZzogbWV0YWRhdGEudmFsaWRhdG9yIHx8IFZhbGlkYXRvckltcGwgfSxcbiAgICAgICAgICAgICAgICB7IHByb3ZpZGU6IEJ1bGssIGRlcHM6IFsgQURBTUFOVF9DT05ORUNUSU9OLCBBREFNQU5UX0VOVElUWV9DTEFTUywgQURBTUFOVF9FTlRJVFlfTUVUQURBVEEsIEh5ZHJhdG9yLCBWYWxpZGF0b3IgXSB9XG4gICAgICAgICAgICBdXG4gICAgICAgIH0pLmdldDxBZGFtYW50UmVwb3NpdG9yeTxUPj4oQWRhbWFudFJlcG9zaXRvcnkpO1xuICAgIH1cbiAgICBcbiAgICBnZXRNZXRhZGF0YTxUPihlbnRpdHlDbGFzcyA6IEN0b3I8VD4pIDogTWV0YWRhdGE8VD4ge1xuICAgICAgICBpZighdGhpcy5tZXRhZGF0YS5oYXMoZW50aXR5Q2xhc3MpKSB7XG4gICAgICAgICAgICB0aGlzLm1ldGFkYXRhLnNldChlbnRpdHlDbGFzcywgdGhpcy5jcmVhdGVNZXRhZGF0YShlbnRpdHlDbGFzcykpO1xuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICByZXR1cm4gdGhpcy5tZXRhZGF0YS5nZXQoZW50aXR5Q2xhc3MpITtcbiAgICB9XG4gICAgXG4gICAgcHJvdGVjdGVkIGNyZWF0ZU1ldGFkYXRhPFQ+KGVudGl0eUNsYXNzIDogQ3RvcjxUPikgOiBNZXRhZGF0YTxUPiB7XG4gICAgICAgIHJldHVybiBuZXcgTWV0YWRhdGE8VD4oZW50aXR5Q2xhc3MpO1xuICAgIH1cbn1cbiJdfQ==